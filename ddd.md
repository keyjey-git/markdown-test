

~~~plantuml

node ユースケースレイヤー #pink{
  node アプリケーションサービス
}

node インタフェース
node サービス
note right
ステートレスな振る舞い
end note
node イベント

node ドメインレイヤー #lightblue{
  node ファクトリ
  node リポジトリ
  package 集約{
    node エンティティ{
      rectangle 一意な識別子
      rectangle 変化する属性
    }
    node バリューオブジェクト{
      rectangle 不変
    }
  }

  package 集約2{
    node エンティティ as entity2
    node エンティティ as entity3
    node バリューオブジェクト as vobj1
    node バリューオブジェクト as vobj2
  }
  package 集約3{
    rectangle 振る舞い
  }
}

エンティティ -- バリューオブジェクト

entity2 -- vobj1
entity2 -- entity3
entity3 -- vobj2

リポジトリ -- 集約 : 永続化

インタフェース -- リポジトリ
インタフェース -- 振る舞い
リポジトリ --> ファクトリ
ファクトリ --> 集約 : インスタンス生成

サービス --> 集約2
サービス --> 集約3

アプリケーションサービス --> インタフェース : 振る舞いの実行を指示
アプリケーションサービス --> サービス : 振る舞いの実行を指示

~~~


# ドメイン
* 業務・機能・情報を表す単位
* モデルが持つデータへのアクセサを提供するものではない
* 振る舞いを提供する
* 1つのドメインが(同じユビキタス言語で)複数の意味を持ってはいけない(複数の意味に解釈できてはいけない)
* どんなオブジェクトであっても、そのメソッド内から実行できるメソッドは次のパターンのみ
  * オブジェクト自身のメソッド
  * 自身にパラメータとして渡されたオブジェクトのメソッド
  * 自身の内部でインスタンス化されたオブジェクトのメソッド
  * 自身が保持しており、直接アクセスできるオブジェクトのメソッド

## エンティティとバリューオブジェクト
* エンティティは識別子を持ち、識別子以外のあらゆる属性が変化しても同じオブジェクトである

* あるエンティティがそれを管理・内包するオブジェクト以外から作られないようにする
  * コンストラクタをprotectedにする

~~~plantuml
package ドメイン{
  node エンティティ{
    rectangle 一意な識別子
    rectangle 属性が変化する
  }

  usecase ユーザーが指定する
  usecase アプリケーションが生成する
  usecase 外部が生成する
  usecase インスタンス化時に生成
  usecase 永続化決定時までに生成

  ユーザーが指定する --> 一意な識別子
  アプリケーションが生成する --> 一意な識別子
  外部が生成する --> 一意な識別子
  一意な識別子 --> インスタンス化時に生成
  一意な識別子 --> 永続化決定時までに生成

  node バリューオブジェクト{
    rectangle 不変
  }

  rectangle "計測・定量化・説明" as desc1
  usecase 初期化
  usecase コピー
  usecase コンストラクタによって置き換えられる
  usecase 属性がすべて同じなら異なるインスタンスでも同じオブジェクト
  usecase 副作用のない関数
  usecase 常に同じ結果
  usecase 置き換え

  desc1 --> バリューオブジェクト
  初期化 --> コンストラクタによって置き換えられる
  コピー --> コンストラクタによって置き換えられる
  コンストラクタによって置き換えられる --> 不変
  不変 --> 属性がすべて同じなら異なるインスタンスでも同じオブジェクト
  不変 --> 副作用のない関数
  副作用のない関数 --> 常に同じ結果
  副作用のない関数 --> 置き換え


  エンティティ --- バリューオブジェクト

}
~~~

## このオブジェクトはエンティティなのか、バリューオブジェクトなのか
* ドメインにおける何かのモノである
  * エンティティ
* 測定値や量など、モノの性質を説明している
  * バリューオブジェクト
* 一意な識別子を必要とする
  * エンティティ
* 個別のインスタンスを区別する必要がある
  * エンティティ
* オブジェクトの状態の変化を追跡できる必要がある
  * エンティティ
* **データモデル設計の都合でドメインとエンティティを決めていないか**？

# ドメインサービス
* ドメインに特化したタスクをこなす、ステートレスな操作
  * 重要なビジネスロジックを実行する
  * ドメインオブジェクトを、一つの構成から別の構成に変換する
  * 複数のドメインオブジェクトからの入力に基づいて、値を算出する
  * ドメインに対して「〇〇してください」と依頼する操作

* セパレートインタフェースを使う必要があるのか

# ドメインイベント

* ドメインの振る舞いの結果を、通知する場合に用意するもの
  * ドメインにおける振る舞いの結果を複数の境界が異なるモデルに通知する必要がある場合
  * 複数のドメインにおける振る舞いの結果による整合性を求められる場合
* ドメインモデル図上の「～～されたら」「～～した時」等を表現するもの

1. きっかけとなるドメインが振る舞いを実行した結果、イベントをディスパッチする
1. 1.のイベントがきっかけとなる別のドメインの振る舞いは、イベントを予めサブスクライブする
1. 2.のサブスクライバによる各々の振る舞いの結果を実行する

~~~plantuml
node アプリケーションサービス
rectangle ドメインイベント as ドメインイベント2
note right
出来事の過去形の名前を持つ
イベントの結果の情報をすべて持つ
end note
package 集約1{
  rectangle ドメインイベント
}
package 集約2
package 集約3

アプリケーションサービス --> 集約1 : 振る舞いの実行を要求
集約1 --> ドメインイベント : 振る舞いの結果(ドメインイベントクラスをインスタンス化)
ドメインイベント2 <-- ドメインイベント : ドメインイベントを返す
アプリケーションサービス --> ドメインイベント2 : publish
ドメインイベント2 <-- 集約2 : subscribe
ドメインイベント2 <-- 集約3 : subscribe


~~~


# 集約
* エンティティやバリューオブジェクトの集まり
  * たった1つのエンティティだけでも集約は成立する
* トランザクション整合性を持つ
  * トランザクション整合性の境界がある集約と別の集約の境界を表す
     * 基本的にはこれだけを唯一絶対のルールとして決めればOK
* **1つの集約はルートエンティティとその他最小限の属性・値型のプロパティだけで構成する。** のを目指すべき
* 集約の境界は、業務の制約とも一致する


## トランザクション
* 1つのトランザクションでは、1つの集約しか変更できない。のを目指すべき
* 1つのトランザクションで参照する側と参照される側の両方を変更してはいけない。
* 複数のインスタンスを単一のトランザクションで変更しようとしている場合、現状の集約の境界が誤っている可能性がある
  * 外部の集約の持つ識別子のみを参照し、外部の集約のオブジェクトそのものを保持してはいけない
* 複数の集約に対する振る舞いの実行が求められる場合、結果整合性を求めること。
  * 1つのインスタンスの変更時、関連する全てのインスタンスも変更が終わっている、というのは不可能な場合もある
* トランザクションを制御するのはアプリケーションサービスの役割
  * ある振る舞いを実現するために、どうトランザクションを管理するのか＝アプリケーションサービスが担うビジネスロジック
    * 振る舞いそのもの＝ドメイン(サービス,リポジトリ)が担うビジネスロジック

## 集約からドメインを追跡するパターン1
~~~plantuml
node アプリケーションサービス
package 集約{
  node リポジトリ{
    rectangle ドメイン
  }
}

アプリケーションサービス --> 集約 : 振る舞いの実行
集約 --> リポジトリ : 追跡
リポジトリ --> ドメイン : 検索
~~~

## 集約からドメインを追跡するパターン2(依存関係の処理をアプリケーションサービスがやる)
~~~plantuml
node アプリケーションサービス
node ドメインサービス
package 集約{
  node リポジトリ{
    rectangle ドメイン
  }
}

アプリケーションサービス --> ドメインサービス : 追跡
アプリケーションサービス --> リポジトリ : 追跡
ドメインサービス --> ドメイン : 検索
リポジトリ --> ドメイン : 検索
アプリケーションサービス --> 集約 : 振る舞いの実行
~~~

## 複数の集約を変更する場合のパターン

~~~plantuml
node アプリケーションサービス
package 集約1
node イベント
package 集約2
package 集約3

アプリケーションサービス --> 集約1 : 振る舞いの実行
集約1 --> イベント : publish
イベント <-- 集約2 : subscribe
イベント <-- 集約3 : subscribe


~~~

# リポジトリ
* **集約のインスタンス**を永続化させる入れ物
 * グローバルなインタフェースを経由してアクセスできる
 * インスタンスの追加と削除を提供する
 * インスタンスの検索を提供する

# サービス
* 複数の集約をまたがるようなワークフローを提供する


# コンテキスト
* ドメインの有効範囲を示す
* 属するコンテキストが異なるドメインは、似たような名前であっても異なる目的を持っているはず
* ドメイン以外にもモジュール、集約、イベント、サービスが範囲に属する
* コンテキストの中には、その範囲で表現される概念のみが登場する。

# ファクトリ

* 集約におけるメソッドの(考え方の)1つ
* 集約そのもののインスタンスを生成するためのもの
  * 集約のコンストラクタ（あるいはそれを呼び出すためのオブジェクト＝サービス）
* オブジェクト自身の生成に様々な入力・条件があり、その知識をオブジェクト自身が抱えるのは望ましくないと判断したら用意する

# アプリケーションサービス
* 命じろ、たずねるな